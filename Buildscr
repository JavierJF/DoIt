# -*- sh -*-
# Build script for DoIt.

module doit

set Version $(!builddate).$(vcsid)

in doit do perl -i -pe 's/6.66/$(Version)/ if /AC_INIT/' configure.ac
in doit do ./mkauto.sh

# Substitute the right revision number in the README.
in doit do perl -i -pe 's/<<VER>>/$(Version)/' README

# Build the Windows binary.
delegate windows
  in doit do/win vcvars32 && nmake /f Makefile.vc VER=/DVERSION=$(Version)
  # Code-sign this Windows binary, if the local bob config provides a
  # script to do so. We assume here that the script accepts an -i
  # option to provide a 'more info' URL, and that it signs the file in
  # place.
  ifneq "$(winsigncode)" "" in doit do $(winsigncode) -i http://www.chiark.greenend.org.uk/~sgtatham/doit/ doit.exe
  return doit/doit.exe
enddelegate
in doit do chmod +x doit.exe

# Zip and tar up the source directory.
in doit do zip -9 ../doit.zip * -x Buildscr
in . do tar --exclude=Buildscr -chzf doit.tar.gz doit

# And deliver those archives, plus the text documentation for the web page.
deliver doit.zip $@
deliver doit.tar.gz $@
deliver doit/doitdoc.txt $@
